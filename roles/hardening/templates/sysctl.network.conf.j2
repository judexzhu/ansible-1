# IPv4 hardening

# Tune network performance
# Increase default buffers to 64MB
net.core.rmem_max = 67108864
net.core.wmem_max = 67108864
# increase TCP buffers up to 32M
net.ipv4.tcp_rmem = 4096 87380 33554432
net.ipv4.tcp_wmem = 4096 65536 33554432
# recommended default congestion control is htcp
net.ipv4.tcp_congestion_control=htcp
# recommended for hosts with jumbo frames enabled
net.ipv4.tcp_mtu_probing=1
# recommended for CentOS7/Debian8 hosts
net.core.default_qdisc = fq
net.ipv4.tcp_mtu_probing = 1

# Enable syn cookies to avoid syn attack
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_synack_retries = 2

# Forbid source routing
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0

# Forbid ICMP redirects
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0

# Do not send redirects either
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0


# Enable spoof protection
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# Ignore ping requests
net.ipv4.icmp_echo_ignore_all = 1

# Ignore broadcast pings
net.ipv4.icmp_echo_ignore_broadcasts = 1

# Ignore bad messages
net.ipv4.icmp_ignore_bogus_error_responses = 1

# Log spoofed sources
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1


# Tune network performance
net.ipv4.netfilter.ip_conntrack_tcp_timeout_time_wait = 5

net.ipv4.tcp_rmem = 10240 87380 4194304
net.ipv4.tcp_wmem = 10240 87380 4194304

net.core.wmem_max = 4194304
net.core.rmem_max = 4194304

net.core.somaxconn = 1024

net.ipv4.ip_forward_use_pmtu = 1
net.ipv4.tcp_sack = 1

# Tune conntrack
net.netfilter.nf_conntrack_tcp_timeout_established=600

# Enable/disable ip forwarding

net.ipv4.ip_forward = {{ 1 if net_ip_forward|default(False) else 0 }}

# Allow more client ports
# Default is roughly 32768 to 60999
net.ipv4.ip_local_port_range = 15000 61000


# IPv6 hardening

# Disable forwarding

net.ipv6.conf.all.forwarding = 0
net.ipv6.conf.default.forwarding = 0

# Ignore RA

net.ipv6.conf.all.accept_ra = 0
net.ipv6.conf.default.accept_ra = 0

# Ignore redirects

net.ipv6.conf.default.accept_redirect = 0
net.ipv6.conf.all.accept_redirect = 0

# Limit network info requests

net.ipv6.conf.default.router_solicitations = 0

net.ipv6.conf.default.accept_ra_rtr_pref = 0
net.ipv6.conf.default.accept_ra_pinfo = 0
net.ipv6.conf.default.accept_ra_defrtr = 0

net.ipv6.conf.default.autoconf = 0
net.ipv6.conf.default.dad_transmits = 0
net.ipv6.conf.default.max_addresses = 1

# Enable IPv6 Privacy Extensions
net.ipv6.conf.all.use_tempaddr = 2
net.ipv6.conf.default.use_tempaddr = 2

